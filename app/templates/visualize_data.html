{% extends "base.html" %}

{% block title %}trckd - My Collection{% endblock %}

{% block extra_css %}
    <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="../static/css/visual.css">
    <link rel="stylesheet" type="text/css" href="../static/css/filters.css">
    <link rel="stylesheet" type="text/css" href="../static/css/cards.css">
    <link rel="stylesheet" type="text/css" href="../static/css/buttons.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <h1 style="text-align: center; font-weight: bold">My Magic: The Gathering Collection</h1>
    
    <div class="d-flex justify-content-between mb-3">
        <button id="updatePricesBtn" class="rounded-pill filter-button px-2 py-2">
            <i class="fas fa-sync-alt"></i> Update Card Prices
        </button>
    </div>

    {% if cards %}
    <!-- Filter Bar - Only show if cards exist -->
    <div class="filter-bar d-flex align-items-center justify-content-start p-3">
        <input type="text" id="searchBox" placeholder="Search cards..." class="form-control mr-2" />

        <select id="typeFilter" class="form-control mr-2">
            <option value="" selected>Type</option>
            <option value="Creature">Creature</option>
            <option value="Instant">Instant</option>
            <option value="Sorcery">Sorcery</option>
            <option value="Enchantment">Enchantment</option>
            <option value="Planeswalker">Planeswalker</option>
            <option value="Land">Land</option>
            <option value="Battle">Battle</option>
            <option value="Conspiracy">Conspiracy</option>
            <option value="Tribal">Tribal</option>
            <option value="Vanguard">Vanguard</option>
            <option value="Scheme">Scheme</option>
        </select>

        <select id="colorFilter" class="form-control mr-2">
            <option value="" selected>Color</option>
            <option value="Blue">Blue</option>
            <option value="Red">Red</option>
            <option value="Black">Black</option>
            <option value="Green">Green</option>
            <option value="White">White</option>
        </select>

        <select id="rarityFilter" class="form-control mr-2">
            <option value="" selected>Rarity</option>
            <option value="Common">Common</option>
            <option value="Uncommon">Uncommon</option>
            <option value="Rare">Rare</option>
            <option value="Mythic">Mythic</option>
        </select>

        <button id="applyFilters" class="btn btn-primary">Apply</button>
        <button id="resetFilters" class="btn btn-secondary">Reset Filters</button>
    </div>

    <!-- Featured Card Slider - Only show if cards exist -->
    <div class="card-slider-wrapper position-relative">
        <button class="filter-button rounded-pill slide-btn left" onclick="slideLeft()">&#8249;</button>

        <div class="card-slider d-flex" id="cardSlider">
            {% for card in cards %}
                <div class="card"
                     data-name="{{ card.name | lower }}"
                     data-type="{{ card.type_line | lower }}"
                     data-color="{{ card.colors | join(',') | lower }}"
                     data-rarity="{{ card.rarity | lower }}"
                     data-id="{{ card.card_ID }}">
                    <div class="card-image">
                        {% if card.image_uris and card.image_uris.normal %}
                            <img src="{{ card.image_uris.normal }}" alt="{{ card.name }}" loading="lazy" />
                        {% elif card.card_faces and card.card_faces[0].image_uris %}
                            <img src="{{ card.card_faces[0].image_uris.normal }}" alt="{{ card.name }}" loading="lazy" />
                        {% else %}
                            <img src="{{ url_for('static', filename='images/card-back.jpg') }}" alt="Card Back" />
                        {% endif %}
                    </div>
                    <div class="card-content">
                        <h6>{{ card.name }}</h6>
                        <p>Type: {{ card.type_line }}</p>
                        <p>Colour: {{ card.colors | join(', ') }}</p>
                        <p>Rarity: {{ card.rarity.title() }}</p>
                        
                        <!-- Always show the pricing section -->
                        <div class="card-pricing">
                            <p>Purchase Price: {% if card.acquisition_price != 'N/A' %}${{ card.acquisition_price }}{% else %}N/A{% endif %}</p>
                            <p>Current Price: {% if card.current_price != 'N/A' %}${{ card.current_price }}{% else %}N/A{% endif %}</p>
                            
                            {% if card.price_difference is defined and card.price_difference is not none %}
                                <!-- If we have price difference data -->
                                <p class="price-change {% if card.price_difference > 0 %}text-success{% elif card.price_difference < 0 %}text-danger{% endif %}">
                                    {% if card.price_difference > 0 %}+{% endif %}${{ "%.2f"|format(card.price_difference) }} 
                                    ({{ "%.1f"|format(card.price_percent|default(0)) }}%)
                                </p>
                            {% elif card.acquisition_price != 'N/A' and card.current_price != 'N/A' %}
                                <!-- If both prices are the same (no difference calculated) -->
                                <p class="price-change text-secondary">
                                    $0.00 (0.0%)
                                </p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <button class="remove-card rounded-pill px-2 py-2 filter-button" data-id="{{ card.card_ID }}">
                            <i class="fas fa-trash-alt"></i> Remove
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>

        <button class="filter-button rounded-pill slide-btn right" onclick="slideRight()">&#8250;</button>
    </div>
    {% else %}
    <!-- Empty state display -->
    <div class="empty-collection-state text-center p-5 my-4">
        <div class="empty-icon mb-4">
            <i class="fas fa-search fa-3x"></i>
        </div>
        <h3 class="mb-3">Your collection is empty</h3>
        <p class="lead mb-4">Start building your collection by adding cards from the search page.</p>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
    // Slider logic
    function slideLeft() {
        const slider = document.getElementById('cardSlider');
        slider.scrollBy({ left: -300, behavior: 'smooth' });  // Adjusted from -300
    }

    function slideRight() {
        const slider = document.getElementById('cardSlider');
        slider.scrollBy({ left: 300, behavior: 'smooth' });  // Adjusted from 300
    }

    // Filter logic
    document.getElementById("applyFilters").addEventListener("click", function () {
        const search = document.getElementById("searchBox").value.toLowerCase();
        const type = document.getElementById("typeFilter").value.toLowerCase();
        const color = document.getElementById("colorFilter").value.toLowerCase();
        const rarity = document.getElementById("rarityFilter").value.toLowerCase();

        const cards = document.querySelectorAll(".card-slider .card");

        cards.forEach(card => {
            const name = card.getAttribute("data-name");
            const cardType = card.getAttribute("data-type");
            const cardColor = card.getAttribute("data-color");
            const cardRarity = card.getAttribute("data-rarity");

            const matchesSearch = !search || name.includes(search);
            const matchesType = !type || cardType.includes(type);
            const matchesColor = !color || cardColor.includes(color);
            const matchesRarity = !rarity || cardRarity.includes(rarity);

            card.style.display = (matchesSearch && matchesType && matchesColor && matchesRarity) ? "block" : "none";
        });
    });

    // Card removal logic
    document.addEventListener('DOMContentLoaded', function() {
        // Find all remove buttons
        document.querySelectorAll('.remove-card').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (!confirm('Are you sure you want to remove this card from your collection?')) {
                    return;
                }
                
                const cardId = this.getAttribute('data-id');
                const cardElement = this.closest('.card');
                
                // Send deletion request
                fetch(`/remove_card/${cardId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        // Remove the card element from the DOM
                        cardElement.remove();
                        
                        // Show success message
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success';
                        alertDiv.textContent = data.message;
                        document.querySelector('.container').prepend(alertDiv);
                        
                        // Hide alert after 3 seconds
                        setTimeout(() => alertDiv.remove(), 3000);
                        
                        // If no cards left, reload page to show empty state
                        if (document.querySelectorAll('.card-slider .card').length === 0) {
                            location.reload();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error removing card:', error);
                    alert('There was an error removing the card.');
                });
            });
        });
    });

    document.getElementById('updatePricesBtn').addEventListener('click', function() {
        // Show loading indicator
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating Prices...';
        this.disabled = true;
        
        // Send request to update prices
        fetch('/update_prices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            // Reload the page to show updated prices
            window.location.reload();
        })
        .catch(error => {
            console.error('Error updating prices:', error);
            alert('There was an error updating prices.');
        })
        .finally(() => {
            // Reset button state
            this.innerHTML = '<i class="fas fa-sync-alt"></i> Update Card Prices';
            this.disabled = false;
        });
    });
</script>

<script src="{{ url_for('static', filename='js/visualize.js') }}"></script>
{% endblock %}



